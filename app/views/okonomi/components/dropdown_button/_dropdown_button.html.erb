<%
  # Extract dropdown builder from block execution
  yield(dropdown_builder)
  
  primary = dropdown_builder.primary_item
  menu_items = dropdown_builder.menu_items
  
  # Check if there are any menu items beyond the primary
  has_menu_items = menu_items.any? { |item| item != primary }
  
  # For split buttons, we need to handle borders specially for outlined variant
  is_outlined = base_button_classes.include?("border")
  is_text_variant = !base_button_classes.include?("border") && !base_button_classes.include?("bg-")
  
  # Build classes for the primary action
  if is_text_variant
    # Text variant: keep normal rounded corners
    primary_classes = base_button_classes
      .gsub(/px-2/, "px-2 pr-3")  # Increase right padding
  else
    # Other variants: remove right border radius and handle borders
    primary_classes = base_button_classes
      .gsub(/rounded-md/, "rounded-l-md")
      .gsub(/px-2/, "px-2 pr-3")  # Increase right padding
    
    # Add border-r-0 for outlined variant to remove double border
    primary_classes += " border-r-0" if is_outlined
  end
  
  # Build classes for dropdown trigger
  if is_text_variant
    # Text variant: keep normal rounded corners and add spacing
    trigger_classes = base_button_classes
      .gsub(/px-\d+/, "px-2") + " ml-1"
  else
    # Other variants: remove left border radius and overlap
    trigger_classes = base_button_classes
      .gsub(/rounded-md/, "rounded-r-md")
      .gsub(/px-\d+/, "px-2") + " -ml-px"
  end
%>

<div <%= tag.attributes(options.merge(
  class: ["relative inline-block", options[:class]].compact.join(" "),
  data: (options[:data] || {}).merge(controller: "dropdown", action: "click@window->dropdown#closeOnClickOutside")
)) %>>
  <% if primary && !has_menu_items %>
    <%# Render only primary button when no menu items %>
    <% if primary[:type] == :link %>
      <%= link_to primary[:options], primary[:html_options].merge(
        class: base_button_classes
      ) do %>
        <% if primary[:icon] %>
          <%= ui.icon(primary[:icon], class: component.style(:primary, :icon)) %>
        <% end %>
        <% if primary[:block] %>
          <%= capture(&primary[:block]) %>
        <% else %>
          <%= primary[:name] %>
        <% end %>
      <% end %>
    <% elsif primary[:type] == :button %>
      <%= button_to primary[:options], primary[:html_options].merge(
        class: base_button_classes
      ) do %>
        <% if primary[:icon] %>
          <%= ui.icon(primary[:icon], class: component.style(:primary, :icon)) %>
        <% end %>
        <% if primary[:block] %>
          <%= capture(&primary[:block]) %>
        <% else %>
          <%= primary[:name] %>
        <% end %>
      <% end %>
    <% elsif primary[:type] == :button_tag %>
      <%= button_tag primary[:options].merge(
        class: base_button_classes
      ) do %>
        <% if primary[:icon] %>
          <%= ui.icon(primary[:icon], class: component.style(:primary, :icon)) %>
        <% end %>
        <% if primary[:block] %>
          <%= capture(&primary[:block]) %>
        <% else %>
          <%= primary[:name] %>
        <% end %>
      <% end %>
    <% end %>
  <% elsif primary && has_menu_items %>
    <div class="relative inline-flex">
      <% if primary[:type] == :link %>
        <% primary_options = primary[:html_options].dup %>
        <%= link_to primary[:options], primary_options.merge(
          class: primary_classes
        ) do %>
          <% if primary[:icon] %>
            <%= ui.icon(primary[:icon], class: component.style(:primary, :icon)) %>
          <% end %>
          <% if primary[:block] %>
            <%= capture(&primary[:block]) %>
          <% else %>
            <%= primary[:name] %>
          <% end %>
        <% end %>
      <% elsif primary[:type] == :button %>
        <% primary_options = primary[:html_options].dup %>
        <%= button_to primary[:options], primary_options.merge(
          class: primary_classes
        ) do %>
          <% if primary[:icon] %>
            <%= ui.icon(primary[:icon], class: component.style(:primary, :icon)) %>
          <% end %>
          <% if primary[:block] %>
            <%= capture(&primary[:block]) %>
          <% else %>
            <%= primary[:name] %>
          <% end %>
        <% end %>
      <% elsif primary[:type] == :button_tag %>
        <% primary_options = primary[:options].dup %>
        <%= button_tag primary_options.merge(
          class: primary_classes
        ) do %>
          <% if primary[:icon] %>
            <%= ui.icon(primary[:icon], class: component.style(:primary, :icon)) %>
          <% end %>
          <% if primary[:block] %>
            <%= capture(&primary[:block]) %>
          <% else %>
            <%= primary[:name] %>
          <% end %>
        <% end %>
      <% end %>
      
      <button type="button" 
              class="<%= trigger_classes %>" 
              data-action="click->dropdown#toggle"
              aria-haspopup="true"
              aria-expanded="false">
        <span class="sr-only">Open options</span>
        <%= ui.icon("heroicons/solid/chevron-down", class: component.style(:primary, :chevron)) %>
      </button>
    </div>
  <% else %>
    <button type="button" 
            class="<%= base_button_classes %>" 
            data-action="click->dropdown#toggle"
            aria-haspopup="true"
            aria-expanded="false">
      Options
      <%= ui.icon("heroicons/solid/chevron-down", class: "-mr-1 h-5 w-5") %>
    </button>
  <% end %>
  
  <% if has_menu_items %>
    <div class="<%= menu_classes %> hidden" data-dropdown-target="menu">
      <div class="py-1" role="menu" aria-orientation="vertical">
        <% # Check if any menu item has an icon to ensure consistent alignment %>
        <% has_any_icon = menu_items.any? { |item| item != primary && item[:icon] && item[:type] != :divider } %>
        
        <% menu_items.each do |item| %>
        <% next if item == primary %> <%# Skip the primary item in the menu %>
        
        <% if item[:type] == :divider %>
          <div class="<%= component.style(:menu, :divider) %>" role="separator"></div>
        <% elsif item[:type] == :link %>
          <% link_options = item[:html_options].dup %>
          <% icon_path = item[:icon] %>
          <% link_class = [component.style(:menu, :item, :root), link_options.delete(:class)].compact.join(" ") %>
          
          <% # Add deferred close action %>
          <% link_options[:data] ||= {} %>
          <% existing_action = link_options[:data][:action] || link_options.delete("data-action") %>
          <% link_options[:data][:action] = [existing_action, "click->dropdown#closeDeferred"].compact.join(" ") %>
          
          <%= link_to item[:options], link_options.merge(
            class: link_class,
            role: "menuitem"
          ) do %>
            <% if has_any_icon %>
              <span class="<%= component.style(:menu, :item, :label) %>">
                <% if icon_path %>
                  <%= ui.icon(icon_path, class: component.style(:menu, :item, :icon)) %>
                <% else %>
                  <span class="<%= component.style(:menu, :item, :icon) %>"></span>
                <% end %>
                <% if item[:block] %>
                  <%= capture(&item[:block]) %>
                <% else %>
                  <%= item[:name] %>
                <% end %>
              </span>
            <% else %>
              <% if item[:block] %>
                <%= capture(&item[:block]) %>
              <% else %>
                <%= item[:name] %>
              <% end %>
            <% end %>
          <% end %>
        <% elsif item[:type] == :button %>
          <% button_options = item[:html_options].dup %>
          <% icon_path = item[:icon] %>
          <% button_class = [component.style(:menu, :item, :root), button_options.delete(:class)].compact.join(" ") %>
          
          <% # Add deferred close action %>
          <% button_options[:data] ||= {} %>
          <% existing_action = button_options[:data][:action] || button_options.delete("data-action") %>
          <% button_options[:data][:action] = [existing_action, "click->dropdown#closeDeferred"].compact.join(" ") %>
          
          <%= button_to item[:options], button_options.merge(
            class: button_class,
            role: "menuitem"
          ) do %>
            <% if has_any_icon %>
              <span class="<%= component.style(:menu, :item, :label) %>">
                <% if icon_path %>
                  <%= ui.icon(icon_path, class: component.style(:menu, :item, :icon)) %>
                <% else %>
                  <span class="<%= component.style(:menu, :item, :icon) %>"></span>
                <% end %>
                <% if item[:block] %>
                  <%= capture(&item[:block]) %>
                <% else %>
                  <%= item[:name] %>
                <% end %>
              </span>
            <% else %>
              <% if item[:block] %>
                <%= capture(&item[:block]) %>
              <% else %>
                <%= item[:name] %>
              <% end %>
            <% end %>
          <% end %>
        <% elsif item[:type] == :button_tag %>
          <% button_options = item[:options].dup %>
          <% icon_path = item[:icon] %>
          <% button_class = [component.style(:menu, :item, :root), button_options.delete(:class)].compact.join(" ") %>
          
          <% # Add deferred close action %>
          <% button_options[:data] ||= {} %>
          <% existing_action = button_options[:data][:action] || button_options.delete("data-action") %>
          <% button_options[:data][:action] = [existing_action, "click->dropdown#closeDeferred"].compact.join(" ") %>
          
          <% # Handle onclick attribute if present %>
          <% if button_options[:onclick] %>
            <% original_onclick = button_options[:onclick] %>
            <% button_options[:onclick] = "#{original_onclick}; setTimeout(() => { this.closest('[data-controller=\"dropdown\"]').querySelector('[data-dropdown-target=\"menu\"]').classList.add('hidden'); }, 50);" %>
          <% end %>
          
          <%= button_tag button_options.merge(
            class: button_class,
            role: "menuitem"
          ) do %>
            <% if has_any_icon %>
              <span class="<%= component.style(:menu, :item, :label) %>">
                <% if icon_path %>
                  <%= ui.icon(icon_path, class: component.style(:menu, :item, :icon)) %>
                <% else %>
                  <span class="<%= component.style(:menu, :item, :icon) %>"></span>
                <% end %>
                <% if item[:block] %>
                  <%= capture(&item[:block]) %>
                <% else %>
                  <%= item[:name] %>
                <% end %>
              </span>
            <% else %>
              <% if item[:block] %>
                <%= capture(&item[:block]) %>
              <% else %>
                <%= item[:name] %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>
  <% end %>
</div>